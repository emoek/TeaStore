FROM rabbitmq:management
MAINTAINER Chair of Software Engineering <se2-it@informatik.uni-wuerzburg.de>

COPY apache-tomcat-8.5.24.zip /apache.zip
COPY rabbitmq.config /etc/rabbitmq/
COPY custom_definitions.json /etc/rabbitmq/

RUN apt-get update
RUN apt-get install unzip
RUN unzip /apache.zip
RUN chmod -R +x /apache-tomcat-8.5.24
RUN apt-get -y install default-jre-headless

COPY target/*.war /apache-tomcat-8.5.24/webapps/logs.war

EXPOSE 8080

# Define the ENTRYPOINT
ENTRYPOINT [ \
    "/bin/sh", "-c", \
    "/apache-tomcat-8.5.24/bin/startup.sh && echo '<% response.sendRedirect(\"/logs/index\"); %>' > /apache-tomcat-8.5.24/webapps/ROOT/index.jsp && rabbitmq-server" \
]

# Define default CMD
#CMD sh -c 'while [ ! -f /apache-tomcat-8.5.24/webapps/logs/kieker-* ]; do sleep 1; done; tail -f /apache-tomcat-8.5.24/webapps/logs/kieker-* > /var/log/custom.log'

